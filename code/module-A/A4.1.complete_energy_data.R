##CR: Update header date and and purpose
#------------------------------------------------------------------------------
# Program Name: A4.1.complete_energy_data.R
# Author(s): Jon Seibert, Linh Vu, Rachel Hoesly
# Date Last Modified: 21 December 2015
# Program Purpose: To expand IEA_BP energy data to include entries for all possible
#                  id combinations.
# Input Files: A.IEA_BP_energy_ext.csv, Master_Fuel_Sector_List.xlsx,
#              Master_Country_List.csv, Master_Fuel_Sector_List.xlsx
# Output Files: A.comb_activity.csv , A.NC_activity_energy
# Notes:
# TODO:
#-------------------------------------------------------------------------------

# ------------------------------------------------------------------------------
# 0. Read in global settings and headers
# Define PARAM_DIR as the location of the CEDS "parameters" directory, relative
# to the "input" directory.
    PARAM_DIR <- if("input" %in% dir()) "code/parameters/" else "../code/parameters/"

# Call standard script header function to read in universal header files -
# provide logging, file support, and system functions - and start the script log.
    headers <- c( "data_functions.R", "analysis_functions.R" ) # Additional function files required.
    log_msg <- "Completion of all combustion data entries" # First message to be printed to the log
    script_name <- "A4.1.complete_energy_data.R"

    source( paste0( PARAM_DIR, "header.R" ) )
    initialize( script_name, log_msg, headers )

# ------------------------------------------------------------------------------
# 1. Read in files

    energy_data <- readData( "MED_OUT", "A.IEA_BP_energy_ext" )

    MFL <- readData( "MAPPINGS", "Master_Fuel_Sector_List", ".xlsx", sheet_selection = "Fuels" )
    MSL <- readData( "MAPPINGS", "Master_Fuel_Sector_List", ".xlsx", sheet_selection = "Sectors" )
    MCL <- readData( "MAPPINGS", "Master_Country_List" )

# ------------------------------------------------------------------------------
# 2. Separate combustion and activity energy data, separate other transformation

# Separate CEDS combustion and other transformation from other tracked
#    IEA energy trends (ex: domestic supply)
##CR: why combine other transformation in the first place (A2.3) if we're just separating it again?
    IEA_other_energy_trends <- energy_data %>%
        filter( sector %!in% MSL$sector )
    other_transformation <- energy_data %>%
        filter( sector %in% c( "1A1bc_Other-feedstocks", "1A1bc_Other-transformation" ))
    energy_data <- energy_data %>%
        filter( sector %!in% c( "1A1bc_Other-feedstocks", "1A1bc_Other-transformation"),
                sector %in% MSL$sector )

    energy_data_combustion <- energy_data[ energy_data$fuel != 'process', ]

# ------------------------------------------------------------------------------
# 3. Create combustion activity database - Populate missing iso-sector-fuel combinations

# Build empty energy data database with all combinations

# Whether these lists include biomass and/or process sectors is easily editable-
# left out for now via reasonable assumption.
    iso_list <- sort( unique( MCL$iso[ !grepl( "historical",  MCL$note ) ] ) )
    sector_list <- unique( c( MSL$sector[ MSL$activity == "Energy_Combustion" ],
                              unique( energy_data_combustion$sector[
                                      energy_data_combustion$sector != "NA" ] ) ) )
# fuel_list <- unique( MFL$fuel[ MFL$fuel != "process" & MFL$fuel != "biomass" ] )
    fuel_list <- unique( MFL$fuel[ MFL$fuel != "process" ] )

# Remove NA-sector biomass entries for now
    energy_data_combustion <-
        na.omit( energy_data_combustion[ energy_data_combustion$sector != "NA", ] )

# Use header function to generate blank template data frame
    ##CR: more efficient to filter sectors before building template
    template <- buildCEDSTemplate( iso_list, sector_list, fuel_list ) %>%
        filter( sector %!in% c( "1A1bc_Other-feedstock", "1A1bc_Other-transformation") )

# Insert existing data into blank template
    full_energy_data_combustion <- merge( template,    ### Could use a dplyr join instead
                                          energy_data_combustion,
                                          by = c( "iso", "sector", "fuel" ),
                                          all.x = TRUE,
                                          suffixes = c( ".t", ".e" ) )

    original_names <- c( "iso", "sector", "fuel", "units", X_emissions_years )
    merge_names <- c( "iso", "sector", "fuel", "units.t", paste0( X_emissions_years, ".e" ) )

# Extract energy data columns and rename
    full_energy_data_combustion <- full_energy_data_combustion[ merge_names ]
    names( full_energy_data_combustion ) <- original_names

# Replace merge-generated NAs with 0
    full_energy_data_combustion[ is.na( full_energy_data_combustion ) ] <- 0

# Sort
    full_energy_data_combustion <-
        full_energy_data_combustion[ with( full_energy_data_combustion,
                                           order( iso, sector, fuel ) ), ]

# ------------------------------------------------------------------------------
# 5. Aggregate fuel summary
##CR: fix numbering ^
##CR: avoid plyr/dplyr conflicts with mutate function by using dplyr::mutate
    other_transformation_aggregate <- other_transformation %>%
        mutate(fuel = replace(fuel, fuel == 'hard_coal', 'coal')) %>%
        mutate(fuel = replace(fuel, fuel == 'brown_coal', 'coal')) %>%
        mutate(fuel = replace(fuel, fuel == 'natural_gas', 'gas')) %>%
        mutate(fuel = replace(fuel, fuel == 'petroleum', 'oil')) %>%
        arrange( iso, sector, fuel ) %>%
        group_by(iso, fuel, sector, units) %>%
        summarize_all(funs(sum))

    total_fuel_consumption <- full_energy_data_combustion %>%
        left_join(MFL[c('fuel','aggregated_fuel')], by = "fuel") %>%
        mutate(fuel = ifelse(is.na(aggregated_fuel), "coal", aggregated_fuel)) %>%
        select(-aggregated_fuel) %>%
        rbind.fill(other_transformation_aggregate) %>%
        select(-sector) %>%
        group_by(iso, fuel, units) %>%
        summarize_all(funs(sum))

# ------------------------------------------------------------------------------
# 6. Output
# Add comments for each table
    comments.A.comb_activity <- c( paste0( "IEA energy statistics",
            " by intermediate sector / intermediate fuel / historical year,",
            " extended with BP data and filled out with all combustion",
            " iso-sector-fuel combinations." ) )
    comments.A.other_IEA_energy_values <- c( paste0( "IEA energy statistics values that are not",
                                                 " specific energy trends by sector/fuel (ie domestic supply),",
                                                 " extended with BP data and filled out with all combustion",
                                                 " iso-sector-fuel combinations." ) )
# write out data
    writeData( full_energy_data_combustion, domain = "MED_OUT",
               fn = "A.comb_activity", comments = comments.A.comb_activity )
    writeData( other_transformation, domain = "MED_OUT",
               fn = "A.Other_transformation_fuel")
    writeData( other_transformation_aggregate, domain = "MED_OUT",
               fn = "A.Other_transformation_agg_fuel")
    writeData( total_fuel_consumption, domain = "MED_OUT",
               fn = "A.total_agg_fuel")
    writeData( IEA_other_energy_trends, domain = "MED_OUT",
               fn = "A.other_IEA_energy_values",
               comments = comments.A.other_IEA_energy_values)
##CR: just in general we need a consistent naming convention for files wrt capitalization
    logStop()

# END
